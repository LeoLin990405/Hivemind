#!/usr/bin/env python3.13
"""
ccb-poll - Batch query status for CCB Gateway requests.

Usage:
    ccb-poll <request_id> [request_id ...]
    echo "id1 id2" | ccb-poll
    ccb-poll -f ids.txt

Options:
    -f, --file FILE   Read request IDs from file (one per line)
    --json            Output raw JSON response
"""
from __future__ import annotations

import argparse
import json
import os
import sys
import urllib.request
import urllib.error
from typing import List, Tuple, Optional


def get_gateway_url() -> str:
    return os.environ.get("CCB_GATEWAY_URL", "http://localhost:8765")


def read_ids_from_file(path: str) -> List[str]:
    try:
        with open(path, "r", encoding="utf-8") as handle:
            return [line.strip() for line in handle if line.strip()]
    except Exception as exc:
        print(f"Error: Failed to read file: {exc}", file=sys.stderr)
        return []


def read_ids_from_stdin() -> List[str]:
    data = sys.stdin.read()
    return [token for token in data.split() if token.strip()]


def post_json(url: str, payload: dict, timeout_s: float = 10.0) -> Tuple[Optional[dict], Optional[str]]:
    try:
        req = urllib.request.Request(
            url,
            data=json.dumps(payload).encode(),
            headers={"Content-Type": "application/json"},
            method="POST",
        )
        with urllib.request.urlopen(req, timeout=timeout_s) as response:
            return json.loads(response.read().decode()), None
    except urllib.error.HTTPError as exc:
        body = exc.read().decode() if exc.fp else ""
        return None, f"HTTP {exc.code}: {body or exc.reason}"
    except urllib.error.URLError as exc:
        return None, f"Cannot connect to gateway: {exc}"
    except Exception as exc:
        return None, str(exc)


def format_status(status: str) -> str:
    if status in ("completed",):
        return "completed ✅"
    if status in ("failed",):
        return "failed ❌"
    if status in ("timeout",):
        return "timeout ⏱️"
    if status in ("queued", "processing", "retrying"):
        return f"{status} ⏳"
    return status or "unknown"


def main() -> int:
    parser = argparse.ArgumentParser(prog="ccb-poll", description="Batch query status for request IDs.")
    parser.add_argument("request_ids", nargs="*", help="Request IDs to query")
    parser.add_argument("-f", "--file", help="Read request IDs from file (one per line)")
    parser.add_argument("--json", action="store_true", help="Output raw JSON")
    args = parser.parse_args()

    request_ids: List[str] = []
    if args.file:
        request_ids.extend(read_ids_from_file(args.file))
    request_ids.extend([rid for rid in args.request_ids if rid.strip()])

    if not request_ids and not sys.stdin.isatty():
        request_ids.extend(read_ids_from_stdin())

    request_ids = [rid for rid in request_ids if rid]

    if not request_ids:
        print("Usage: ccb-poll <request_id> [request_id ...]", file=sys.stderr)
        return 1

    gateway_url = get_gateway_url()
    data, error = post_json(f"{gateway_url}/api/batch/status", {"request_ids": request_ids})
    if error:
        print(f"Error: {error}", file=sys.stderr)
        return 1

    if args.json:
        print(json.dumps(data, ensure_ascii=False, indent=2))
        return 0

    for result in data.get("results", []):
        request_id = result.get("request_id", "")
        if not result.get("found", False):
            print(f"{request_id}: not_found")
            continue
        status = format_status(result.get("status"))
        print(f"{request_id}: {status}")

    return 0


if __name__ == "__main__":
    sys.exit(main())
