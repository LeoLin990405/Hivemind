#!/usr/bin/env python3
"""
oask - Send message to OpenCode via Gateway API.
"""

from __future__ import annotations

import os
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

try:
    from compat import read_stdin_text, setup_windows_encoding
    setup_windows_encoding()
except ImportError:
    def read_stdin_text():
        return sys.stdin.read()

from cli_output import EXIT_ERROR, EXIT_OK, atomic_write_text
from gateway_client import gateway_ask_opencode


def _usage() -> None:
    print("Usage: oask [--timeout SECONDS] [--output FILE] <message>", file=sys.stderr)


def main(argv: list[str]) -> int:
    if len(argv) <= 1 and sys.stdin.isatty():
        _usage()
        return EXIT_ERROR

    output_path: Path | None = None
    timeout: float | None = None
    quiet = False

    parts: list[str] = []
    it = iter(argv[1:])
    for token in it:
        if token in ("-h", "--help"):
            _usage()
            return EXIT_OK
        if token in ("-q", "--quiet"):
            quiet = True
            continue
        if token in ("-o", "--output"):
            try:
                output_path = Path(next(it)).expanduser()
            except StopIteration:
                print("[ERROR] --output requires a file path", file=sys.stderr)
                return EXIT_ERROR
            continue
        if token in ("-t", "--timeout"):
            try:
                timeout = float(next(it))
            except StopIteration:
                print("[ERROR] --timeout requires a number", file=sys.stderr)
                return EXIT_ERROR
            except ValueError:
                print("[ERROR] --timeout must be a number", file=sys.stderr)
                return EXIT_ERROR
            continue
        parts.append(token)

    message = " ".join(parts).strip()
    if not message and not sys.stdin.isatty():
        message = read_stdin_text().strip()
    if not message:
        print("[ERROR] Message cannot be empty", file=sys.stderr)
        return EXIT_ERROR

    if timeout is None:
        try:
            timeout = float(os.environ.get("CCB_SYNC_TIMEOUT", "300"))
        except Exception:
            timeout = 300.0

    try:
        # Use Gateway API
        reply, exit_code = gateway_ask_opencode(message, timeout_s=timeout if timeout > 0 else 300.0, wait=True)
        if reply:
            if output_path:
                atomic_write_text(output_path, reply + "\n")
                return exit_code
            sys.stdout.write(reply)
            if not reply.endswith("\n"):
                sys.stdout.write("\n")
        return exit_code
    except KeyboardInterrupt:
        return 130
    except Exception as exc:
        print(f"[ERROR] {exc}", file=sys.stderr)
        return EXIT_ERROR


if __name__ == "__main__":
    sys.exit(main(sys.argv))
